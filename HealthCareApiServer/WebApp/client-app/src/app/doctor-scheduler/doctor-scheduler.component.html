<div class="max-w-7xl mx-auto p-4 md:p-6 bg-slate-50 text-slate-900 min-h-screen">
    <div class="flex flex-col gap-6">

        <!-- ROW 1: Calendar (Left) + Schedule View (Middle) -->
        <div class="flex flex-col lg:flex-row gap-6">

            <!-- Left: Calendar (Month Navigator) - Fixed width on large screens -->
            <section class="lg:w-[560px] lg:shrink-0 bg-white border border-slate-200 rounded-2xl shadow-xl p-4 md:p-6"
                id="calendarCard">
                <app-calendar [doctorId]="doctorId" [dates]="dates" [selectedDate]="selectedDate"
                    [currentView]="currentView" (dateSelected)="handleDateSelect($event)"
                    (viewChanged)="handleCalendarViewChange()"></app-calendar>
            </section>

            <!-- Middle: Schedule View (Day/Week/Month & Filters) - Takes remaining space -->
            <section class="lg:flex-1 bg-white border border-slate-200 rounded-2xl shadow-xl p-4 md:p-6">
                <!-- View Selector & Navigation -->
                <div class="flex flex-wrap items-center justify-between gap-4 mb-4">
                    <!-- View Selector -->
                    <div class="flex text-sm border border-slate-200 rounded-xl overflow-hidden shadow-sm">
                        <button class="view-btn px-4 py-2 transition"
                            [ngClass]="{'text-white bg-slate-900 hover:bg-slate-700': currentView === 'day', 'hover:bg-slate-100': currentView !== 'day'}"
                            (click)="setView('day')">Day</button>
                        <button class="view-btn px-4 py-2 border-l border-r border-slate-200 transition"
                            [ngClass]="{'text-white bg-slate-900 hover:bg-slate-700': currentView === 'week', 'hover:bg-slate-100': currentView !== 'week'}"
                            (click)="setView('week')">Week</button>
                        <button class="view-btn px-4 py-2 rounded-r-xl transition"
                            [ngClass]="{'text-white bg-slate-900 hover:bg-slate-700': currentView === 'month', 'hover:bg-slate-100': currentView !== 'month'}"
                            (click)="setView('month')">Month</button>
                    </div>

                    <!-- Date Navigator for Day/Week -->
                    <div class="flex items-center gap-2" [ngClass]="{'hidden': currentView === 'month'}">
                        <button
                            class="px-3 py-2 rounded-xl border border-slate-200 hover:bg-slate-100 transition text-sm"
                            (click)="navigatePeriod(-1)">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="m15 18-6-6 6-6" />
                            </svg>
                        </button>
                        <button
                            class="px-3 py-2 rounded-xl border border-slate-200 hover:bg-slate-100 transition text-sm"
                            (click)="goToday(true)">Today</button>
                        <button
                            class="px-3 py-2 rounded-xl border border-slate-200 hover:bg-slate-100 transition text-sm"
                            (click)="navigatePeriod(1)">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="m9 18 6-6-6-6" />
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Filters -->
                <div class="flex flex-col sm:flex-row items-center gap-2 mb-3">
                    <input type="text" [(ngModel)]="searchQuery" (input)="renderSchedule()"
                        class="w-full border border-slate-200 rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-indigo-300 transition"
                        placeholder="Filter by patient name or reason" />
                    <select [(ngModel)]="statusFilter" (change)="renderSchedule()"
                        class="w-full sm:w-auto border border-slate-200 rounded-xl px-3 py-2 focus:ring-2 focus:ring-indigo-300">
                        <option value="all">All statuses</option>
                        <option value="upcoming">Upcoming</option>
                        <option value="completed">Completed</option>
                        <option value="canceled">Canceled</option>
                    </select>
                </div>
                <div class="text-lg font-bold text-slate-900 mb-2">{{ dateHeading }}</div>

                <div class="grid gap-2 max-h-[350px] overflow-y-auto pr-2">
                    <ng-container *ngIf="filteredAppointments.length > 0; else noAppointments">
                        <ng-container *ngFor="let group of groupedAppointments">
                            <!-- Date Header for Week/Month view -->
                            <div *ngIf="currentView !== 'day'"
                                class="text-sm font-bold text-slate-800 mt-4 mb-2 first:mt-0 pt-2 border-t border-slate-100 first:border-t-0">
                                {{ getDateHeader(group.date) }}
                            </div>

                            <!-- Appointments for the day -->
                            <button *ngFor="let item of group.appts" (click)="openDetail(item)"
                                [attr.data-appt-id]="item.id"
                                class="appt-item grid grid-cols-[70px_1fr] gap-2 border border-slate-200 rounded-xl p-3 bg-white hover:bg-slate-50 text-left w-full transition duration-150"
                                [class.selected]="selectedAppt?.id === item.id">
                                <div class="font-semibold text-slate-900">{{ item.dateTime | date: 'HH:mm' }}</div>
                                <div>
                                    <div class="flex items-center gap-2">
                                        <strong class="text-indigo-800">{{ item.patient?.fullName || 'Unknown' }}</strong>
                                        <span class="text-xs px-2 py-0.5 rounded-full border text-slate-700"
                                            [ngClass]="getApptStatusClasses(item.status)">
                                            {{ item.status | enumText: AppointmentStatus }}
                                        </span>
                                    </div>
                                    <div class="text-sm text-slate-600 truncate">{{ item.reason }}</div>
                                </div>
                            </button>
                        </ng-container>
                    </ng-container>
                </div>

                <ng-template #noAppointments>
                    <div
                        class="text-slate-600 p-4 border border-dashed border-slate-300 rounded-xl mt-2 text-center text-sm">
                        No matching appointments found for this {{ currentView | lowercase }} view.
                    </div>
                </ng-template>
            </section>

        </div> <!-- End of ROW 1 container -->

        <!-- ROW 2: Appointment details -->
        <section class="bg-white border border-slate-200 rounded-2xl shadow-xl p-4 md:p-6">
            <h2 class="text-xl font-bold mb-4 text-slate-800">Appointment Details</h2>

            <div *ngIf="!selectedAppt" class="text-slate-600 p-4 bg-slate-50 rounded-xl text-sm">
                Select an appointment from the list above to view patient info, notes, prescriptions, and previous
                visits.
            </div>

            <div *ngIf="selectedAppt && currentPatient" class="grid gap-6">

                <!-- Patient Info -->
                <div
                    class="flex flex-col sm:flex-row items-start gap-4 border border-slate-200 rounded-xl p-4 bg-indigo-50/50">
                    <img [src]=""
                        class="w-16 h-16 rounded-full object-cover ring-2 ring-indigo-300 shrink-0" alt="Patient Avatar"
                        onerror="this.onerror=null; this.src='https://placehold.co/64x64/E2E8F0/94A3B8?text=P'" />
                    <div class="grid gap-1 flex-1">
                        <div class="font-bold text-lg text-indigo-800">{{ currentPatient.fullName }}</div>
                        <div class="text-sm text-slate-600">{{ patientMeta }}</div>
                    </div>
                </div>

                <div class="grid lg:grid-cols-2 gap-6">
                    <!-- LEFT COLUMN: Visit, Notes, Prescriptions -->
                    <div class="grid gap-6">

                        <!-- Current Appointment -->
                        <div class="grid gap-2 p-4 border border-slate-100 rounded-xl bg-slate-50">
                            <div class="font-semibold text-base text-slate-800 border-b border-slate-200 pb-2">Current
                                Visit</div>
                            <div class="flex items-start justify-between gap-4 flex-wrap">
                                <div class="grid gap-1 text-sm">
                                    <div><span class="text-slate-600">Date:</span> <span class="font-medium">{{
                                            selectedAppt.dateTime | date: 'shortDate' }}</span></div>
                                    <div><span class="text-slate-600">Time:</span> <span class="font-medium">{{
                                            selectedAppt.dateTime | date: 'HH:mm' }}</span></div>
                                    <div><span class="text-slate-600">Reason:</span> <span class="font-medium">{{
                                            selectedAppt.reason }}</span></div>
                                    <div><span class="text-slate-600">Status:</span> <span
                                            class="text-xs px-2 py-0.5 rounded-full border font-medium capitalize"
                                            [ngClass]="getApptStatusClasses(selectedAppt.status)">{{ selectedAppt.status | enumText: AppointmentStatus }}</span></div>
                                </div>
                                <div class="flex gap-2 flex-wrap">
                                    <button
                                        class="px-3 py-2 rounded-xl bg-green-600 text-white hover:bg-green-700 transition disabled:opacity-50 text-sm font-medium"
                                        (click)="updateStatus(AppointmentStatus.Completed)"
                                        [disabled]="selectedAppt.status === AppointmentStatus.Completed || selectedAppt.status === AppointmentStatus.Canceled">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                            stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                            stroke-linejoin="round" class="inline align-middle mr-1">
                                            <path d="M20 6 9 17l-5-5" />
                                        </svg>
                                        Complete</button>
                                    <button
                                        class="px-3 py-2 rounded-xl border border-red-400 text-red-600 hover:bg-red-50 transition disabled:opacity-50 text-sm font-medium"
                                        (click)="updateStatus(AppointmentStatus.Canceled)"
                                        [disabled]="selectedAppt.status === AppointmentStatus.Canceled || selectedAppt.status === AppointmentStatus.Completed">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                            stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                            stroke-linejoin="round" class="inline align-middle mr-1">
                                            <path d="M18 6 6 18" />
                                            <path d="m6 6 12 12" />
                                        </svg>
                                        Cancel</button>
                                </div>
                            </div>
                        </div>

                        <!-- Notes -->
                        <div class="grid gap-2">
                            <div class="font-semibold text-base text-slate-800 border-b border-slate-200 pb-2">Notes
                            </div>
                            <div class="grid gap-2 max-h-[150px] overflow-y-auto pr-2">
                                <!-- <ng-container *ngIf="currentPatient.notes.length > 0; else noNotes">
                                    <div *ngFor="let note of currentPatient.notes"
                                        class="border border-slate-200 rounded-xl px-3 py-2 bg-slate-50 text-sm">
                                        {{ note }}
                                    </div>
                                </ng-container> -->
                                <ng-template #noNotes>
                                    <div class="text-slate-600 italic text-sm p-2 bg-slate-50 rounded-xl">No patient
                                        notes yet.</div>
                                </ng-template>
                            </div>
                            <div class="flex gap-2 pt-1">
                                <input type="text" [(ngModel)]="newNoteText" (keyup.enter)="addNote()"
                                    class="w-full border border-slate-200 rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-indigo-300 text-sm"
                                    placeholder="Add a quick note…" />
                                <button
                                    class="px-4 py-2 rounded-xl bg-slate-900 text-white hover:bg-slate-700 transition text-sm font-medium"
                                    (click)="addNote()">Add</button>
                            </div>
                        </div>
                    </div>

                    <!-- RIGHT COLUMN: Prescriptions & Previous Visits -->
                    <div class="grid gap-6">
                        <!-- Prescriptions -->
                        <div class="grid gap-3">
                            <div class="font-semibold text-base text-slate-800 border-b border-slate-200 pb-2">Active
                                Prescriptions</div>
                            <div class="grid gap-2 max-h-[150px] overflow-y-auto pr-2">
                                <!-- FIX: Updated trackBy to use the component method trackByRxId -->
                                <ng-container *ngIf="activePrescriptions.length > 0; else noRx">
                                    <div *ngFor="let rx of activePrescriptions; trackBy: trackByRxId"
                                        class="border border-indigo-200 rounded-xl p-3 bg-indigo-50 grid gap-1 shadow-sm">
                                        <div class="flex items-center justify-between gap-2">
                                            <div><strong class="text-indigo-900 text-sm">{{ rx.name }}</strong> —
                                                <span class="text-xs font-medium text-slate-700">{{ rx.dose }}</span>
                                            </div>
                                            <button
                                                class="text-xs px-2 py-0.5 rounded-xl border border-red-300 text-red-600 hover:bg-red-50 transition shrink-0"
                                                (click)="stopPrescription(rx.id)">Stop Rx</button>
                                        </div>
                                        <div class="text-slate-600 text-xs">
                                            <span
                                                class="px-2 py-0.5 rounded-full bg-indigo-200 text-indigo-800 font-medium mr-1">{{
                                                rx.durationInDays }} days</span>
                                            ({{ rx.startDate }} to {{ computeEndDate(rx.startDate, rx.durationInDays) }})
                                        </div>
                                        <div class="flex flex-wrap gap-2 pt-1 border-t border-indigo-100 mt-1">
                                            <span *ngFor="let t of rx.times"
                                                class='px-2 py-0.5 rounded-full bg-white border border-indigo-100 text-xs text-indigo-700 font-mono'>{{
                                                t }}</span>
                                        </div>
                                    </div>
                                </ng-container>
                                <ng-template #noRx>
                                    <div class="text-slate-600 italic text-sm p-2 bg-slate-50 rounded-xl">No active
                                        prescriptions.</div>
                                </ng-template>
                            </div>

                            <div class="border border-slate-200 rounded-xl p-3 grid gap-3 bg-slate-50">
                                <h3 class="font-medium text-sm text-slate-700">Add New Prescription</h3>
                                <div class="grid grid-cols-2 gap-2">
                                    <input type="text" [(ngModel)]="rxNameInput"
                                        class="border border-slate-200 rounded-xl px-3 py-2 text-sm"
                                        placeholder="Medication name" />
                                    <input type="text" [(ngModel)]="rxDoseInput"
                                        class="border border-slate-200 rounded-xl px-3 py-2 text-sm"
                                        placeholder="Dose (e.g., 50 mg)" />
                                    <input type="number" [(ngModel)]="rxDaysInput"
                                        class="border border-slate-200 rounded-xl px-3 py-2 text-sm" min="1"
                                        placeholder="Days" />
                                    <select [(ngModel)]="rxTimesPerDayInput"
                                        (change)="buildTimeInputs(+rxTimesPerDayInput)"
                                        class="border border-slate-200 rounded-xl px-3 py-2 text-sm">
                                        <option value="1">1× per day</option>
                                        <option value="2">2× per day</option>
                                        <option value="3">3× per day</option>
                                        <option value="4">4× per day</option>
                                    </select>
                                </div>
                                <div class="flex flex-wrap gap-2 border-t pt-3 mt-1 border-slate-100">
                                    <input *ngFor="let time of rxTimeInputs; let i = index" type="time" [ngModel]="time"
                                        (ngModelChange)="setRxTime(i, $event)"
                                        class="border border-slate-200 rounded-xl px-3 py-2 text-sm w-[110px] focus:ring-2 focus:ring-indigo-300" />
                                </div>
                                <button
                                    class="px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 transition text-sm font-medium"
                                    (click)="addPrescription()">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                        class="inline align-middle mr-1">
                                        <path d="M5 12h14" />
                                        <path d="M12 5v14" />
                                    </svg>
                                    Add Prescription
                                </button>
                            </div>
                        </div>

                        <!-- Previous Visits -->
                        <div class="grid gap-2">
                            <div class="font-semibold text-base text-slate-800 border-b border-slate-200 pb-2">Previous
                                Visits</div>
                            <div class="max-h-[200px] overflow-y-auto pr-2">
                                <table class="w-full text-sm border-collapse">
                                    <thead>
                                        <tr class="text-left text-slate-600">
                                            <th class="py-2 border-b border-slate-200 font-medium">Date</th>
                                            <th class="py-2 border-b border-slate-200 font-medium">Reason</th>
                                            <th class="py-2 border-b border-slate-200 font-medium">Outcome</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <ng-container *ngIf="previousVisits.length > 0; else noPrevVisits">
                                            <tr *ngFor="let visit of previousVisits"
                                                class="hover:bg-slate-50 transition">
                                                <td class='py-2 border-b border-slate-200'>{{ visit.dateTime | date: 'short' }}</td>
                                                <td class='py-2 border-b border-slate-200 text-slate-700'>{{
                                                    visit.reason }}</td>
                                                <td class='py-2 border-b border-slate-200 capitalize text-slate-700'>{{ visit.status | enumText: AppointmentStatus }}</td>
                                            </tr>
                                        </ng-container>
                                        <ng-template #noPrevVisits>
                                            <tr>
                                                <td colspan="3" class="text-slate-600 py-2 italic text-center">No
                                                    previous completed visits found.</td>
                                            </tr>
                                        </ng-template>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>
</div>