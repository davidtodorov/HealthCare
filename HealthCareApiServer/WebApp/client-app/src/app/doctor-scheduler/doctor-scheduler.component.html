<div class="max-w-7xl mx-auto p-4 md:p-6 bg-slate-50 text-slate-900 min-h-screen">
    <div class="flex flex-col gap-6">

        <!-- ROW 1: Calendar (Left) + Schedule View (Middle) -->
        <div class="flex flex-col lg:flex-row gap-6">

            <!-- Left: Calendar (Month Navigator) - Fixed width on large screens -->
            <section class="lg:w-[560px] lg:shrink-0 bg-white border border-slate-200 rounded-2xl shadow-xl p-4 md:p-6"
                id="calendarCard">
                <app-calendar [doctorId]="doctorId" [dates]="dates" [selectedDate]="selectedDate"
                    [currentView]="currentView" (dateSelected)="handleDateSelect($event)"
                    (viewChanged)="handleCalendarViewChange()"></app-calendar>
            </section>

            <!-- Middle: Schedule View (Day/Week/Month & Filters) - Takes remaining space -->
            <section class="lg:flex-1 bg-white border border-slate-200 rounded-2xl shadow-xl p-4 md:p-6">
                <!-- View Selector & Navigation -->
                <div class="flex flex-wrap items-center justify-between gap-4 mb-4">
                    <!-- View Selector -->
                    <div class="flex text-sm border border-slate-200 rounded-xl overflow-hidden shadow-sm">
                        <button class="view-btn px-4 py-2 transition"
                            [ngClass]="{'text-white bg-slate-900 hover:bg-slate-700': currentView === 'day', 'hover:bg-slate-100': currentView !== 'day'}"
                            (click)="setView('day')">Day</button>
                        <button class="view-btn px-4 py-2 border-l border-r border-slate-200 transition"
                            [ngClass]="{'text-white bg-slate-900 hover:bg-slate-700': currentView === 'week', 'hover:bg-slate-100': currentView !== 'week'}"
                            (click)="setView('week')">Week</button>
                        <button class="view-btn px-4 py-2 rounded-r-xl transition"
                            [ngClass]="{'text-white bg-slate-900 hover:bg-slate-700': currentView === 'month', 'hover:bg-slate-100': currentView !== 'month'}"
                            (click)="setView('month')">Month</button>
                    </div>

                    <!-- Date Navigator for Day/Week -->
                    <div class="flex items-center gap-2" [ngClass]="{'hidden': currentView === 'month'}">
                        <button
                            class="px-3 py-2 rounded-xl border border-slate-200 hover:bg-slate-100 transition text-sm"
                            (click)="navigatePeriod(-1)">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="m15 18-6-6 6-6" />
                            </svg>
                        </button>
                        <button
                            class="px-3 py-2 rounded-xl border border-slate-200 hover:bg-slate-100 transition text-sm"
                            (click)="goToday(true)">Today</button>
                        <button
                            class="px-3 py-2 rounded-xl border border-slate-200 hover:bg-slate-100 transition text-sm"
                            (click)="navigatePeriod(1)">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="m9 18 6-6-6-6" />
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Filters -->
                <div class="flex flex-col sm:flex-row items-center gap-2 mb-3">
                    <input type="text" [(ngModel)]="searchQuery" (input)="renderSchedule()"
                        class="w-full border border-slate-200 rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-indigo-300 transition"
                        placeholder="Filter by patient name or reason" />
                    <select [(ngModel)]="statusFilter" (change)="renderSchedule()"
                        class="w-full sm:w-auto border border-slate-200 rounded-xl px-3 py-2 focus:ring-2 focus:ring-indigo-300">
                        <option value="all">All statuses</option>
                        <option [ngValue]="AppointmentStatus.Upcoming">Upcoming</option>
                        <option [ngValue]="AppointmentStatus.Completed">Completed</option>
                        <option [ngValue]="AppointmentStatus.Canceled">Canceled</option>
                    </select>
                </div>
                <div class="text-lg font-bold text-slate-900 mb-2">{{ dateHeading }}</div>

                <div class="grid gap-2 max-h-[350px] overflow-y-auto pr-2">
                    <ng-container *ngIf="filteredAppointments.length > 0; else noAppointments">
                        <ng-container *ngFor="let group of groupedAppointments">
                            <!-- Date Header for Week/Month view -->
                            <div *ngIf="currentView !== 'day'"
                                class="text-sm font-bold text-slate-800 mt-4 mb-2 first:mt-0 pt-2 border-t border-slate-100 first:border-t-0">
                                {{ getDateHeader(group.date) }}
                            </div>

                            <!-- Appointments for the day -->
                            <button *ngFor="let item of group.appts" (click)="openDetail(item)"
                                [attr.data-appt-id]="item.id"
                                class="appt-item grid grid-cols-[70px_1fr] gap-2 border border-slate-200 rounded-xl p-3 bg-white hover:bg-slate-50 text-left w-full transition duration-150"
                                [class.selected]="selectedAppt?.id === item.id">
                                <div class="font-semibold text-slate-900">{{ item.dateTime | date: 'HH:mm' }}</div>
                                <div>
                                    <div class="flex items-center gap-2">
                                        <strong class="text-indigo-800">{{ item.patient?.fullName || 'Unknown' }}</strong>
                                        <span class="text-xs px-2 py-0.5 rounded-full border text-slate-700"
                                            [ngClass]="getApptStatusClasses(item.status)">
                                            {{ item.status | enumText: AppointmentStatus }}
                                        </span>
                                    </div>
                                    <div class="text-sm text-slate-600 truncate">{{ item.reason }}</div>
                                </div>
                            </button>
                        </ng-container>
                    </ng-container>
                </div>

                <ng-template #noAppointments>
                    <div
                        class="text-slate-600 p-4 border border-dashed border-slate-300 rounded-xl mt-2 text-center text-sm">
                        No matching appointments found for this {{ currentView | lowercase }} view.
                    </div>
                </ng-template>
            </section>

        </div> <!-- End of ROW 1 container -->

    </div>
</div>